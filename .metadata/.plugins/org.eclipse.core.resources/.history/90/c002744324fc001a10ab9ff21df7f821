package plugin.explosiveWand.events;

import java.lang.reflect.Field;

import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.data.BlockData;
import org.bukkit.craftbukkit.v1_16_R2.CraftWorld;
import org.bukkit.entity.FallingBlock;
import org.bukkit.entity.Fireball;
import org.bukkit.entity.Player;
import org.bukkit.entity.Projectile;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.Action;
import org.bukkit.event.entity.ProjectileHitEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.util.Vector;

import net.minecraft.server.v1_16_R2.Blocks;
import net.minecraft.server.v1_16_R2.EntityFallingBlock;
import net.minecraft.server.v1_16_R2.WorldServer;
import plugin.explosiveWand.customEntities.CustomFallingBlock;
import plugin.explosiveWand.customEntities.CustomZombie;
import plugin.explosiveWand.items.Wand;

public class Events implements Listener {
	
	@EventHandler
	public void onRightClick(PlayerInteractEvent e) {
		
		Player p = e.getPlayer();
		Location loc = p.getLocation();
		float yaw = p.getLocation().getYaw();
		
		Action action = e.getAction();
		ItemStack item = p.getInventory().getItemInMainHand();
		
		if (action.equals(Action.RIGHT_CLICK_AIR) || action.equals(Action.RIGHT_CLICK_BLOCK)) {
			if (item.getItemMeta().getLore().equals(Wand.wand.getItemMeta().getLore())) {
				Vector front = new Vector(Math.cos(Math.toRadians(yaw+90)), 0, Math.sin(Math.toRadians(yaw+90)));
				front.multiply(1.5);
				Location projLocation = loc.clone().add(0.0, 1.1, 0.0);
				projLocation.add(front);
				
				
				Fireball fireball = p.getWorld().spawn(projLocation, Fireball.class);
				fireball.addScoreboardTag("explosiveProjectile");
				fireball.setYield((float) 2.5);
				
				FallingBlock magma = loc.getWorld().spawnFallingBlock(loc, (BlockData) Blocks.MAGMA_BLOCK.getBlockData());
//				CustomFallingBlock magma = new CustomFallingBlock(loc, Blocks.MAGMA_BLOCK);
//				magma.removeHitbox();
//				
//				WorldServer world = ((CraftWorld) p.getWorld()).getHandle();
//				world.addEntity(magma);				
//				idk
//				CustomZombie z = new CustomZombie(loc);
////				world.addEntity(z);
				
				Vector v = loc.getDirection();
				v.multiply(1.5);
				
//				Field lived;
//				try {
//					lived = EntityFallingBlock.class.getDeclaredField("ticksLived");
//					lived.setAccessible(true);
//					p.sendMessage("" + lived.get(magma));
//					
//				} catch (NoSuchFieldException | SecurityException | IllegalArgumentException | IllegalAccessException e1) {
//					// TODO Auto-generated catch block
//					e1.printStackTrace();
//				}
				
				
				fireball.setVelocity(v);
				fireball.addPassenger(magma);
//				magma.getBukkitEntity().addPassenger(p);
//				fireball.addPassenger(magma.getBukkitEntity());
//				proj.addPassenger(fallingMagma); you have to spawn it at magmalocation
			}
		}
	}
	
	@EventHandler
	public void onProjectileHit(ProjectileHitEvent e) {
		Projectile proj = e.getEntity();
//		Location loc = proj.getLocation();
		
		if (proj.getScoreboardTags().contains("explosiveProjectile")) {

//			proj.getPassengers().get(0).remove();
//			for (Entity entity: proj.getNearbyEntities(1.0, 1.0, 1.0)) {
//				if (entity.getClass().equals(FallingBlock.class)) {
//					FallingBlock fb = (FallingBlock) entity;
//					fb.
//				}
//			}
			
//			e.getEntity().getWorld().createExplosion(arg0, arg1);
		}
	}

}
